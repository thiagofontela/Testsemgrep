name: semgrep-publish

on:
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Semgrep (debug + SARIF + JSON)
        shell: bash
        run: |
          set -eux

          echo "=== Java files under src ==="
          find src -type f -name '*.java' -print || true

          echo "Semgrep version:"
          docker run --rm -v "$GITHUB_WORKSPACE":/src semgrep/semgrep:latest semgrep --version || true

          echo "Running semgrep scan -> SARIF only"
          docker run --rm -v "$GITHUB_WORKSPACE":/src semgrep/semgrep:latest semgrep scan \
            --config /src/semgrep-ruleset.yml \
            --config p/java \
            --config p/spring \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/secrets \
            --include src/main/java \
            --sarif --output /src/semgrep.sarif || true

          echo "Running semgrep scan -> JSON only"
          docker run --rm -v "$GITHUB_WORKSPACE":/src semgrep/semgrep:latest semgrep scan \
            --config /src/semgrep-ruleset.yml \
            --config p/java \
            --config p/spring \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/secrets \
            --include src/main/java \
            --json --output /src/semgrep.full.json || true

          echo "Files produced (sizes):"
          ls -lh semgrep.sarif semgrep.full.json || true

          echo "---- semgrep.sarif quick summary ----"
          if [ -f semgrep.sarif ]; then
            jq '.runs[].tool.driver.name, (.runs[]?.results | length)' semgrep.sarif || true
            jq '.runs[]?.results[]? | {ruleId, message: .message.text, file: .locations[0]?.physicalLocation?.artifactLocation?.uri, line: .locations[0]?.physicalLocation?.region?.startLine}' semgrep.sarif | sed -n '1,200p' || true
          fi

          echo "---- semgrep.full.json (first 2000 chars) ----"
          if [ -f semgrep.full.json ]; then head -c 2000 semgrep.full.json || true; echo; fi

      - name: Ensure valid SARIF
        shell: bash
        run: |
          if [ ! -s semgrep.sarif ] || ! jq -e '.version and .runs[0].tool.driver.name' semgrep.sarif >/dev/null 2>&1; then
            echo "Creating minimal valid semgrep.sarif fallback"
            jq -n '{
              version:"2.1.0",
              runs:[{
                tool:{driver:{name:"semgrep",informationUri:"https://semgrep.dev"}},
                results:[]
              }]
            }' > semgrep.sarif
          fi

      - name: Debug SARIF size and count
        shell: bash
        run: |
          ls -lh semgrep.sarif || true
          echo "SARIF results:"
          jq '([.runs[]?.results[]?] | length) as $n | "Results: \($n)"' semgrep.sarif || true

      - name: Upload SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: semgrep

      - name: Upload artifacts (SARIF + JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: |
            semgrep.sarif
            semgrep.full.json
          if-no-files-found: warn
