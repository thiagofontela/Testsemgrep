- name: Run Semgrep (debug mode - produce full JSON & show outputs)
  shell: bash
  run: |
    set -eux

    echo "Listing repo and Java files..."
    pwd
    ls -la
    find src -type f -name '*.java' -print || true

    echo "Semgrep version:"
    docker run --rm -v "$GITHUB_WORKSPACE":/src semgrep/semgrep:latest semgrep --version || true

    echo "Running semgrep scan -> sarif + full json"
    docker run --rm -v "$GITHUB_WORKSPACE":/src semgrep/semgrep:latest semgrep scan \
      --config /src/semgrep-ruleset.yml \
      --include src/main/java \
      --sarif --output /src/semgrep.sarif \
      --json --output /src/semgrep.full.json || true

    echo "Files produced:"
    ls -lh semgrep.sarif semgrep.full.json semgrep.report.json || true

    echo "---- semgrep.full.json (first 4000 chars) ----"
    if [ -f semgrep.full.json ]; then
      head -c 4000 semgrep.full.json || true
      echo; echo "---- full json length ----"
      wc -c semgrep.full.json || true
    else
      echo "semgrep.full.json not found"
    fi

    echo "---- semgrep.sarif (jq summary) ----"
    if [ -f semgrep.sarif ]; then
      jq '.runs[].tool.driver.name, (.runs[]?.results | length)' semgrep.sarif || true
      jq '.runs[]?.results[]? | {ruleId, message: .message.text, file: .locations[0]?.physicalLocation?.artifactLocation?.uri, line: .locations[0]?.physicalLocation?.region?.startLine}' semgrep.sarif | sed -n '1,200p' || true
    else
      echo "semgrep.sarif not found"
    fi

    echo "---- semgrep.report.json (our summarized JSON) ----"
    jq '.' semgrep.report.json || echo "semgrep.report.json missing or empty"

    # keep SARIF even if empty (no fail)
    true
