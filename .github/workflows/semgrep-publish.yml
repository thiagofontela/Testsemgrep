name: semgrep-publish

on:
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Semgrep (gera SARIF e JSON)
        shell: bash
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE":/src semgrep/semgrep:latest semgrep scan                     --config /src/semgrep-ruleset.yml                     --config p/java                     --config p/spring                     --config p/owasp-top-ten                     --config p/security-audit                     --config p/secrets                     --include src/main/java                     --sarif --output /src/semgrep.sarif                     --json --output /src/semgrep.full.json || true

          # Fallback: se SARIF ausente/ inválido, cria um SARIF vazio VÁLIDO
          if [ ! -s semgrep.sarif ] || ! jq -e '.version and .runs[0].tool.driver.name' semgrep.sarif >/dev/null 2>&1; then
            jq -n '{
              version:"2.1.0",
              runs:[{
                tool:{driver:{name:"semgrep",informationUri:"https://semgrep.dev"}},
                results:[]
              }]
            }' > semgrep.sarif
          fi

          # Resumo legível a partir do SARIF
          jq '[
                .runs[]?.results[]? |
                {
                  ruleId,
                  level,
                  message: .message.text,
                  file: .locations[0]?.physicalLocation?.artifactLocation?.uri,
                  line: .locations[0]?.physicalLocation?.region?.startLine
                }
              ]' semgrep.sarif > semgrep.report.json || echo '[]' > semgrep.report.json

      - name: Debug SARIF size and count
        shell: bash
        run: |
          ls -lh semgrep.sarif semgrep.report.json semgrep.full.json || true
          echo "SARIF results:"
          jq '([.runs[]?.results[]?] | length) as $n | "Results: \($n)"' semgrep.sarif

      - name: Upload SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: semgrep
          ref: refs/heads/main
          sha: ${{ github.sha }}

      - name: Upload artifacts (SARIF + JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: |
            semgrep.sarif
            semgrep.report.json
            semgrep.full.json
          if-no-files-found: warn
